<html>
<head>
	<meta charset="utf-8">
	<title>Crunch - Examples - RSA</title>

	<script src="../crunch.js" type="text/javascript"></script>

	<style>
		fieldset {
			margin: 15px;
			border: none;
		}

		fieldset.vertical>label {
			float: left;
			clear: left;
			width: 50px;
			padding-top: 4px;
		}
		
		fieldset.vertical>input {
			float: left;
			width: 600px;
		}

		fieldset.vertical>span {
			float: left;
			width: 100px;
			padding: 4px 10px;
		}

		fieldset.vertical>span.small {
			float: left;
			width: 350px;
			padding: 4px 10px;
			color: #999;
		}
	</style>
</head>
<body>

<h1>Crunch RSA Example</h1>
<p>RSA is one of the first practicable public-key cryptosystems. In such a cryptosystem, the encryption key is public and differs from the decryption key which is kept secret. In RSA, this asymmetry is based on the practical difficulty of factoring the product of two large prime numbers.</p>
<p>In this example, the Crunch arbitrary percision arithmetic library is used to generate an RSA key-pair, and uses it to "encrypt" and "decrypt" data.</p>

<fieldset class="vertical">	
	<h2>Generate RSA Key-Pair</h2>
	<p>Select a key size and click Generate. Larger key sizes will take longer to generate. Key material will populate the fields below.</p>
	
	<label for="size">Size</label>
	<select id="size">
		<option value="128">128</option>
		<option value="256">256</option>
		<option value="512">512</option>
		<option value="1024" selected="selected">1024</option>
		<option value="1536">1536</option>
		<option value="2048">2048</option>
		<option value="4096">4096</option>
	</select>
	<button onclick="generateKey(document.getElementById('size').value)">Generate</button>
</fieldset>


<fieldset class="vertical">
	<h2>Private Key Material</h2>
	<label for="p">p</label><input type="text" name="p" id="p" readonly="readonly"><span id="p-time"></span><span class="small">crunch.nextPrime(<em>random N bit number</em>)</span>
	<label for="q">q</label><input type="text" name="q" id="q" readonly="readonly"><span id="q-time"></span><span class="small">crunch.nextPrime(<em>random N bit number</em>)</span>
	<label for="f">f</label><input type="text" name="f" id="f" readonly="readonly"><span id="f-time"></span><span class="small">crunch.mul(crunch.decrement(p), crunch.decrement(q))</span>
	<label for="d">d</label><input type="text" name="d" id="d" readonly="readonly"><span id="d-time"></span><span class="small">crunch.inv(e, f)</span>
	<label for="u">u</label><input type="text" name="u" id="u" readonly="readonly"><span id="u-time"></span><span class="small">crunch.inv(p, q)</span>
</fieldset>

<fieldset class="vertical">
	<h2>Public Key Material</h2>
	<label for="e">e</label><input type="text" name="e" id="e" readonly="readonly"><span id="e-time"></span><span class="small">crunch.nextPrime(<em>random N bit number</em>)</span>
	<label for="n">n</label><input type="text" name="n" id="n" readonly="readonly"><span id="n-time"></span><span class="small">crunch.mul(p, q)</span>
</fieldset>

<fieldset>
	<h2>Modular Exponentiation (Encyption/Decryption)</h2>
	<p>Once a key-pair is generated, you can test the encryption/decryption using the following fields. This actually does modular exponentiation, which is the basis of the RSA cryptosystem.</p>
	<input type="text" name="in" id="in" value="12345678" disabled="disabled">
	<button id="in-button" onclick="encrypt()" disabled="disabled">x ^ e mod n [Encrypt] &rarr;</button>
	<button id="out-button" onclick="decrypt()" disabled="disabled">&larr; x ^ d mod n [Decrypt]</button>
	<input type="text" name="out" id="out" disabled="disabled">
	<span id="c-time"></span>
	<p>The encryption is executed via the function <em>crunch.exp(x, e, n)</em> and decryption via <em>crunch.gar(x, p, q, d, u)</em>.</p>
</fieldset>

<p>The calculations on this page are executed sequentially. Because Crunch is web-worker enabled, some of the above operations could be parallelized for even better performance.</p>

<p><a href="./">&laquo; Back to Examples</a></p>

<script type="text/javascript">
	var p, q, e, n, f, d, u, crunch = Crunch();

	function generateRandom(size) {
		var t = new Uint8Array(Math.ceil(size/8));

		(window.crypto || window.msCrypto).getRandomValues(t);

		return Array.prototype.slice.call(t);
	}

	function generateKey(size, a, b, c) {
		var t;

		if (typeof a === "undefined") {
			a = generateRandom(size/2);
			b = generateRandom(size/2);
			c = generateRandom(size/32);
		}

		t = performance.now();
		p = crunch.nextPrime(a);
		t = (performance.now() - t).toFixed(2);
		document.getElementById("p").value = convert(p);
		document.getElementById("p-time").textContent = t + ' ms';

		t = performance.now();
		q = crunch.nextPrime(b);
		t = (performance.now() - t).toFixed(2);
		document.getElementById("q").value = convert(q);
		document.getElementById("q-time").textContent = t + ' ms';
		
		t = performance.now();
		e = [1, 0, 1];//crunch.nextPrime(c);
		t = (performance.now() - t).toFixed(2);
		document.getElementById("e").value = convert(e);
		document.getElementById("e-time").textContent = t + ' ms';
		
		t = performance.now();
		n = crunch.mul(p, q);
		t = (performance.now() - t).toFixed(2);
		document.getElementById("n").value = convert(n);
		document.getElementById("n-time").textContent = t + ' ms';
		
		t = performance.now();
		f = crunch.mul(crunch.decrement(p), crunch.decrement(q));
		t = (performance.now() - t).toFixed(2);
		document.getElementById("f").value = convert(f);
		document.getElementById("f-time").textContent = t + ' ms';
		
		t = performance.now();
		d = crunch.cut(crunch.inv(e, f));
		t = (performance.now() - t).toFixed(2);
		document.getElementById("d").value = convert(d);
		document.getElementById("d-time").textContent = t + ' ms';
		
		t = performance.now();
		u = crunch.cut(crunch.inv(p, q));
		t = (performance.now() - t).toFixed(2);
		document.getElementById("u").value = convert(u);
		document.getElementById("u-time").textContent = t + ' ms';

		document.getElementById('in').disabled = false;
		document.getElementById('in-button').disabled = false;
	}

	function encrypt() {
		var s = convert(document.getElementById('in').value),
			t = performance.now(),
			r = crunch.exp(s, e, n);

		t = (performance.now() - t).toFixed(2);

		document.getElementById('out').value = convert(r);
		document.getElementById('in').value = '';
		document.getElementById("c-time").textContent = t + ' ms';

		document.getElementById('in').disabled = true;
		document.getElementById('in-button').disabled = true;
		document.getElementById('out').disabled = false;
		document.getElementById('out-button').disabled = false;
	}

	function decrypt() {
		var s = convert(document.getElementById('out').value), 
			t = performance.now(),
			r = crunch.gar(s, p, q, d, u);

		t = (performance.now() - t).toFixed(2);

		document.getElementById('in').value = convert(r);
		document.getElementById('out').value = '';
		document.getElementById("c-time").textContent = t + ' ms';

		document.getElementById('in').disabled = false;
		document.getElementById('in-button').disabled = false;
		document.getElementById('out').disabled = true;
		document.getElementById('out-button').disabled = true;
	}

	//Modified from http://danvk.org/hex2dec.html
	function convert(input) {
		function add(x, y, base) {
			var z = [],
					n = Math.max(x.length, y.length),
					c = 0,
					i = -1,
					xi, yi, zi;

			while (++i < n || c) {
				xi = i < x.length ? x[i] : 0;
				yi = i < y.length ? y[i] : 0;
				zi = c + xi + yi;

				z.push(zi % base);
				c = Math.floor(zi / base);
			}

			return z;
		}

		function multiply(num, x, base) {
			var result = [],
					power = x;

			if (num != 0) {
				while (true) {
					if (num & 1)
						result = add(result, power, base);

					num = num >> 1;

					if (num === 0)
						break;

					power = add(power, power, base);
				}
			}

			return result;
		}

		function convertBase(str, fromBase, toBase) {
			var digits = str.split('').map(function(v) { return parseInt(v, fromBase) }).reverse(),
					result = [],
					power = [1],
					i;

			for (i = 0; i < digits.length; i++) {
				if (digits[i]) {
					result = add(result, multiply(digits[i], power, toBase), toBase);
				}
				power = multiply(fromBase, power, toBase);
			}

			return result.reverse().map(function(v) { return v.toString(toBase) }).join("");
		}

		if (Array.isArray(input)) {
			return convertBase(input.map(function(v) { return ("0"+v.toString(16)).slice(-2) }).join(""), 16, 10);
		} else {
			var hexStr = convertBase(input, 10, 16);

			if (hexStr.length % 2) 
				hexStr = "0" + hexStr;

			return hexStr.match(/.{2}/g).map(function(v) { return parseInt(v, 16) });
		}
	}
</script>

</body>
</html>